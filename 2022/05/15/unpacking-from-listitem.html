<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Nikita Burmistrov | How to Handle ListItem Properties?</title>
  <link rel="stylesheet" href="https://burmistrov-tech.github.io/blog/assets/css/layout.css" />
  <link rel="shortcut icon" href="/favicon.ico"/>
</head><body>

    <div class="wrapper"><header>
  <nav class="links">
    <ul class="static">
      <li><a href="/">Home</a></li>
      <li><a href="/rss.xml">Subscribe</a></li>
      <li><a href="/about-me.html">About Me</a></li>
    </ul>
    <ul class="social">
      <li><a href="https://www.linkedin.com/in/nburmistrov" rel="nofollow"
        title="My LinkedIn profile"><i class="icon-linkedin notranslate" aria-hidden="true"></i></a>
      </li>
      <li><a href="https://github.com/nburmistrov" rel="nofollow"
        title="Follow my GitHub prifle"><i class="icon-github notranslate" aria-hidden="true"></i></a>
      </li>
      <li><a href="https://t.me/nburmistrov" rel="nofollow"
        title="Contant with me via Telegram"><i class="icon-telegram notranslate" aria-hidden="true"></i></a>
      </li>
    </ul>  
  </nav>
</header><article class="markdown-body" itemscope="" itemtype="http://schema.org/BlogPosting">
  <div itemprop="image" itemscope="" itemtype="http://schema.org/ImageObject">
    <meta itemprop="url" content="https://burmistrov-tech.github.io/blog/images/image.png"/>
    <meta itemprop="height" content="250"/>
    <meta itemprop="width" content="250"/>
  </div>
  <meta itemprop="image" content=""/>
  <div itemscope="" itemprop="author" itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Nikita Burmistrov"/>
  </div>
  <div itemscope="" itemprop="publisher" itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Nikita Burmistrov"/>
    <div itemprop="logo" itemscope="" itemtype="http://schema.org/ImageObject">
      <meta itemprop="url" content="https://burmistrov-tech.github.io/blog/images/image.png"/>
      <meta itemprop="height" content="250"/>
      <meta itemprop="width" content="250"/>
    </div>
  </div>
  <div class="title">
    <h1 itemprop="name headline mainEntityOfPage">How to Handle ListItem Properties?</h1>

<ul class="post-metadata">
  <li>
    <time itemprop="datePublished dateModified" datetime="2022-05-15T00:00:00+02:00">
      15 May 2022
    </time>
  </li>
  <li itemprop="wordCount">
    1080 words
  </li>
  <li>
    
    7 minutes to read
  </li>
  <li class="m-hide">
    <i class="icon-comment"></i>
    <a href="https://burmistrov-tech.github.io/blog/2022/05/15/unpacking-from-listitem.html#disqus_thread" itemprop="discussionUrl"></a>
  </li>
</ul>

<script id="dsq-count-scr" src="//www-burmistrov-tech.disqus.com/count.js" async></script>
  <ul class="post-tags"><li class="tag"><a href="/tags/csharp">#csharp</a></li><li class="tag"><a href="/tags/sharepoint">#sharepoint</a></li><li><a href="/tags">see all tags</a></li>
  </ul>
</div>
  <p>During my work with the SharePoint client library, I have encountered many different approaches to working with it. We can consider SharePoint as a niche technology, in some ways already obsolete. But unfortunately, after many years of using this library have not had time to develop good approaches to use, with clear examples and good documentation. With this article, I want to run a series of articles about working with <em>Microsoft.SharePoint.Client</em> library.</p>

<p>One of the most popular tasks is to get an item from a list and get its fields then. Let’s look at the situation of obtaining fields of the ListItem object.</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">context</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ClientContext</span><span class="p">(</span><span class="n">url</span><span class="p">))</span>
<span class="p">{</span>
  <span class="n">List</span> <span class="n">list</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Web</span><span class="p">.</span><span class="nf">GetList</span><span class="p">(</span><span class="s">"Lists/items"</span><span class="p">);</span>
  <span class="n">ListItem</span> <span class="n">item</span> <span class="p">=</span> <span class="n">list</span><span class="p">.</span><span class="nf">GetItemById</span><span class="p">(</span><span class="m">1</span><span class="p">);</span>

  <span class="n">context</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="n">item</span><span class="p">);</span>
  <span class="n">context</span><span class="p">.</span><span class="nf">ExecuteQuery</span><span class="p">();</span>
  
  <span class="c1">// Here is the problem</span>
  <span class="kt">string</span> <span class="n">textField</span> <span class="p">=</span>  <span class="n">Convert</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s">"TestItemText"</span><span class="p">]);</span>
  <span class="kt">double</span> <span class="n">numberField</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">ToDouble</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s">"TestItemNumber"</span><span class="p">]);</span>
  <span class="n">DateTime</span> <span class="n">dateField</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">ToDateTime</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s">"TestItemDate"</span><span class="p">]);</span>

  <span class="k">return</span> <span class="k">new</span> <span class="p">{</span> <span class="n">Text</span> <span class="p">=</span> <span class="n">textField</span><span class="p">,</span> <span class="n">Number</span> <span class="p">=</span> <span class="n">numberField</span> <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>
<blockquote>
  <p>Static methods are like the cancer of object-oriented programming software: once we let them settle in our code, we cannot get rid of them - their colony will only grow. Just avoid them in principle.</p>
</blockquote>

<p>You may not believe me, but this is the most common way of obtaining values that I have encountered. The problem here is that we already know what type to expect in the <em>ListItem</em>, based on the type we set in the settings of our List. The relation of .NET types to field types in SharePoint is below.</p>

<table>
  <tbody>
    <tr>
      <td>C# Type</td>
      <td>SharePoint Type</td>
    </tr>
    <tr>
      <td>string</td>
      <td>Text, Note, Choice</td>
    </tr>
    <tr>
      <td>double?</td>
      <td>Number</td>
    </tr>
    <tr>
      <td>decimal?</td>
      <td>Currency</td>
    </tr>
    <tr>
      <td>DateTime?</td>
      <td>Date and time</td>
    </tr>
    <tr>
      <td>bool?</td>
      <td>Boolean</td>
    </tr>
    <tr>
      <td>FieldUserValue</td>
      <td>User or Group</td>
    </tr>
    <tr>
      <td>FieldLookupValue</td>
      <td>Lookup</td>
    </tr>
    <tr>
      <td>FieldUrlValue</td>
      <td>File or URL</td>
    </tr>
  </tbody>
</table>

<p>As you can see, all fields allow null values. We will have different results in case null value, if we use a <em>static class Convert</em> and if we use a usual unpacking.</p>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// is true</span>
<span class="kt">bool</span> <span class="n">isNull</span> <span class="p">=</span> <span class="n">item</span><span class="p">[</span><span class="s">"TestItemText"</span><span class="p">]</span> <span class="p">==</span> <span class="k">null</span><span class="p">;</span> 

<span class="c1">// string.Empty</span>
<span class="kt">string</span> <span class="n">convertedText</span> <span class="p">=</span> <span class="n">Convert</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s">"TestItemText"</span><span class="p">]);</span> 

<span class="c1">// null</span>
<span class="kt">string</span> <span class="n">castedText</span> <span class="p">=</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span> <span class="n">item</span><span class="p">[</span><span class="s">"TestItemText"</span><span class="p">];</span>
</code></pre></div></div>
<p>To explain this behavior, we need to look at the source code of the <em>Convert.ToString</em> method.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="n">__DynamicallyInvokable</span><span class="p">]</span>
<span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">ToString</span><span class="p">(</span><span class="kt">object</span> <span class="k">value</span><span class="p">)</span> <span class="p">=&gt;</span>
  <span class="n">Convert</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="k">value</span><span class="p">,</span> <span class="p">(</span><span class="n">IFormatProvider</span><span class="p">)</span> <span class="k">null</span><span class="p">);</span>

<span class="p">[</span><span class="n">__DynamicallyInvokable</span><span class="p">]</span>
<span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">ToString</span><span class="p">(</span><span class="kt">object</span> <span class="k">value</span><span class="p">,</span> <span class="n">IFormatProvider</span> <span class="n">provider</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">switch</span> <span class="p">(</span><span class="k">value</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">case</span> <span class="n">IConvertible</span> <span class="n">convertible</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">convertible</span><span class="p">.</span><span class="nf">ToString</span><span class="p">(</span><span class="n">provider</span><span class="p">);</span>
    <span class="k">case</span> <span class="n">IFormattable</span> <span class="n">formattable</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">formattable</span><span class="p">.</span><span class="nf">ToString</span><span class="p">((</span><span class="kt">string</span><span class="p">)</span> <span class="k">null</span><span class="p">,</span> <span class="n">provider</span><span class="p">);</span>
    <span class="c1">// in that case</span>
    <span class="k">case</span> <span class="k">null</span><span class="p">:</span>
      <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>
    <span class="k">default</span><span class="p">:</span>
      <span class="k">return</span> <span class="k">value</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<h2 id="fail-fast-and-fail-safe">Fail Fast and Fail Safe</h2>

<p>I would rather fail faster with Cast error when testing the method than get unexpected values somewhere in other services. If we have made sure with SharePoint types, we can simply convert the object type to the desired value type. Just don’t forget to set a nullable value type or set a desirable default value, in case of null.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">textField</span> <span class="p">=</span> <span class="p">(</span><span class="kt">string</span><span class="p">)</span> <span class="n">item</span><span class="p">[</span><span class="s">"TestItemText"</span><span class="p">];</span>
<span class="kt">var</span> <span class="n">numberField</span> <span class="p">=</span> <span class="p">(</span><span class="kt">double</span><span class="p">?)</span> <span class="n">item</span><span class="p">[</span><span class="s">"TestItemNumber"</span><span class="p">];</span>

<span class="c1">// desirable default value</span>
<span class="kt">var</span> <span class="n">dateField</span> <span class="p">=</span> <span class="p">(</span><span class="n">DateTime</span><span class="p">?)</span> <span class="n">item</span><span class="p">[</span><span class="s">"TestItemDate"</span><span class="p">]</span> <span class="p">??</span> <span class="k">new</span> <span class="nf">DateTime</span><span class="p">(</span><span class="m">2022</span><span class="p">,</span> <span class="m">01</span><span class="p">,</span> <span class="m">01</span><span class="p">);</span>
</code></pre></div></div>

<p>Furthermore, we are able to add a little syntactic sugar and simplify obtaining values from the ListItem and implement the TryGet pattern for exception handling.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">Extensions</span>
<span class="p">{</span>
  <span class="k">public</span> <span class="k">static</span> <span class="n">T</span> <span class="n">GetFieldValue</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">ListItem</span> <span class="n">item</span><span class="p">,</span> <span class="kt">string</span> <span class="n">fieldName</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="n">item</span><span class="p">[</span><span class="n">fieldName</span><span class="p">];</span>
  <span class="p">};</span>

  <span class="k">public</span> <span class="k">static</span> <span class="kt">bool</span> <span class="n">TryGetFieldValue</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">ListItem</span> <span class="n">item</span><span class="p">,</span> <span class="kt">string</span> <span class="n">fieldName</span><span class="p">,</span> <span class="k">out</span> <span class="n">T</span> <span class="k">value</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="k">value</span> <span class="p">=</span> <span class="k">default</span><span class="p">;</span> 
    
    <span class="k">try</span>
    <span class="p">{</span>
        <span class="k">value</span> <span class="p">=</span> <span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="n">item</span><span class="p">[</span><span class="n">fieldName</span><span class="p">];</span>

        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">catch</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">var</span> <span class="n">textField</span> <span class="p">=</span> <span class="n">item</span><span class="p">.</span><span class="n">GetFieldValue</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="s">"TestItemText"</span><span class="p">);</span>
<span class="kt">var</span> <span class="n">numberField</span> <span class="p">=</span> <span class="n">item</span><span class="p">.</span><span class="n">GetFieldValue</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">?&gt;(</span><span class="s">"TestItemNumber"</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">TryGetFieldValue</span><span class="p">&lt;</span><span class="n">DateTime</span><span class="p">&gt;(</span><span class="s">"TestItemDate"</span><span class="p">,</span> <span class="k">out</span> <span class="kt">var</span> <span class="n">dateField</span><span class="p">))</span>
<span class="p">{</span>
  <span class="n">_logger</span><span class="p">.</span><span class="nf">LogInformation</span><span class="p">(</span><span class="s">"Unexpected null value or type error with TestItemDate field"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
<p>Agree, it looks much nicer than before.</p>

<h2 id="what-else-can-be-improved">What else can be improved?</h2>

<p>The solution that we considered fits perfectly with the Rich Domain Model in small projects where we don’t always need to do mapping of SharePoint entities and domain entities. But in large projects, we have to deal with a large number of entities and the process of manual mapping becomes not the most optimal solution.
I have ideas about developing automatic mapping for SharePoint entities similar to <em>System.Text.Json Serializer</em>.</p>

<p>What do you think, will it be useful?</p>

</article>
<div id="disqus_thread"></div>
<script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://www-burmistrov-tech.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><footer>
  <p class="copyright">&copy; Nikita Burmistrov - 2022</p>
</footer></div>
    
  </body>

</html>